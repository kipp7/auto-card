# 部署与运维手册 (Deployment & Maintenance Guide)

---

## 1. 概述 (Overview)

本手册旨在为系统管理员或开发人员提供一套完整的项目部署和日常运维指南。请在执行任何操作前，仔细阅读并理解相关步骤。

## 2. 环境要求 (Environment Requirements)

| 组件 | 最低要求 | 推荐配置 |
| :--- | :--- | :--- |
| **服务器** | 1核 CPU, 2GB RAM, 20GB SSD | 2核 CPU, 4GB RAM, 40GB SSD |
| **操作系统** | CentOS 7+ / Ubuntu 18.04+ | Ubuntu 22.04 LTS |
| **Node.js** | v16.x | v18.x LTS |
| **MySQL** | 5.7 | 8.0 |
| **Web服务器** | Nginx | Nginx (最新稳定版) |
| **进程管理器**| PM2 | PM2 (最新稳定版) |

## 3. 部署步骤 (Deployment Steps)

### 3.1. 前置准备

1.  **服务器初始化**: 确保服务器已安装 `Node.js`, `MySQL`, `Nginx`, `Git`。
2.  **获取代码**: `git clone [your-repo-url] /var/www/auto-card-system`
3.  **数据库准备**: 
    - 登录MySQL: `mysql -u root -p`
    - 创建数据库: `CREATE DATABASE your_db_name CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`
    - 创建用户并授权: `CREATE USER 'your_user'@'localhost' IDENTIFIED BY 'your_password';`
    - `GRANT ALL PRIVILEGES ON your_db_name.* TO 'your_user'@'localhost';`
    - `FLUSH PRIVILEGES;`

### 3.2. 后端服务部署

1.  **进入后端目录**: `cd /var/www/auto-card-system/server`
2.  **安装依赖**: `npm install`
3.  **配置环境变量**: 
    - `cp .env.example .env`
    - `vim .env` (或使用其他编辑器)
    - 仔细填写所有配置项，特别是数据库连接信息和七牛云密钥。
4.  **数据库初始化**: `npm run db:init` (假设 `package.json` 中已配置此脚本)
5.  **启动服务 (使用PM2)**:
    - `pm2 start app.js --name auto-card-api`
    - `pm2 save` (保存进程列表)
    - `pm2 startup` (设置开机自启)

### 3.3. 前端应用部署

#### B端 (管理系统)

1.  **进入B端目录**: `cd /var/www/auto-card-system/admin`
2.  **安装依赖**: `npm install`
3.  **修改API地址**: 确保 `.env.production` 文件中的 `VITE_APP_BASE_API` 指向后端服务的公网地址。
4.  **打包构建**: `npm run build`
5.  **部署产物**: 将 `dist` 目录下的所有文件复制到Nginx的网站根目录，例如 `/var/www/html/admin`。

#### C端 (用户端)

1.  **API地址**: C端默认会自动使用当前站点域名作为 API 地址，无需手动修改。
2.  **部署产物**: 将C端的所有静态文件 (HTML, CSS, JS, images) 复制到Nginx的网站根目录，例如 `/var/www/html/web`。

### 3.4. Nginx 配置

创建一个新的Nginx配置文件 `auto-card.conf` 并配置反向代理：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # C端配置
    location / {
        root /var/www/html/web;
        try_files $uri $uri/ /index.html;
    }

    # B端配置
    location /admin {
        alias /var/www/html/admin;
        try_files $uri $uri/ /admin/index.html;
    }

    # API反向代理
    location /api/ {
        proxy_pass http://localhost:3000; # 假设后端服务运行在3000端口
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

配置完成后，重载Nginx: `sudo systemctl reload nginx`。

### 3.5. Docker Compose 快速部署

适合本地或自建服务器快速启动（包含 MySQL + 后端服务）。

1.  复制环境变量：`cp server/.env.example server/.env` 并填写数据库信息。
2.  启动服务：`docker compose up -d --build`
3.  数据库会自动初始化（容器启动时执行 `db:init`），无需手动执行。
4.  访问地址：
    - C端：`http://localhost:3000/`
    - 管理端：`http://localhost:3000/admin/`

> 说明：Docker 构建会打包管理端产物与 C 端静态页，前端改动需重新 build 镜像。

### 3.6. 配置说明（DB / JWT / 支付）

- **DB_***：数据库连接配置（MySQL/MariaDB）。`docker compose` 会创建空数据库，表结构由 `db:init` 生成。
- **JWT_***：登录鉴权用的签名密钥与过期时间，生产环境务必替换为强随机密钥。
- **支付配置**：当前为演示流程，真实支付可通过 `.env` 中 `PAYMENT_*` 自行接入。

### 3.6. CI 生产交付工作流 (GitHub Actions)

当 `main` 分支有更新时，会自动触发 `Production Build` 工作流：

1. 安装依赖并构建管理端产物
2. 打包交付物（`server/`、`web/`、`admin/dist/`、`docs/`、`scripts/`、`技术文档/`）
3. 产物作为 Actions Artifact 可下载（`auto-card-<commit>`）

如需手动触发，可在 GitHub Actions 中选择 `workflow_dispatch` 执行。

## 4. 日常运维 (Daily Maintenance)

- **查看服务状态**: `pm2 list`
- **查看API日志**: `pm2 logs auto-card-api`
- **重启API服务**: `pm2 restart auto-card-api`
- **数据备份**:
  - Windows：`powershell scripts/backup-db.ps1`
  - Linux/Mac：`bash scripts/backup-db.sh`
  - 输出目录默认为 `backups/`，可传参指定路径与文件名。
- **数据恢复**:
  - Windows：`powershell scripts/restore-db.ps1 backups/xxx.sql`
  - Linux/Mac：`bash scripts/restore-db.sh backups/xxx.sql`
- **项目更新**: 
  1. `cd /var/www/auto-card-system`
  2. `git pull origin develop`
  3. 重新执行相应的前后端部署步骤。

